def label = "spacemesh-pod-${UUID.randomUUID().toString()}"
podTemplate(label: label, containers: [
    containerTemplate(name: 'docker', image: 'docker', ttyEnabled: true, command: 'cat'),
    containerTemplate(name: 'kubectl', image: 'lachlanevenson/k8s-kubectl:v1.8.0', command: 'cat', ttyEnabled: true),
    containerTemplate(name: 'git', image: 'alpine/git', command: 'cat', ttyEnabled: true),
    containerTemplate(name: 'python', image: 'spacemeshos/go-spacemesh-python:main', command: 'cat', alwaysPullImage: true, ttyEnabled: true)
  ],
  volumes: [
    hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock'),
  ])
{
  node(label) {
    withCredentials([string(credentialsId: 'ES_PASSWD', variable: 'SECRET'),
                     string(credentialsId: "${CLUSTER}", variable: 'ESPASS')]) {
        stage('Run pytest') {
            git branch: "${TESTS_BRANCH}",url: 'https://github.com/spacemeshos/go-spacemesh.git'
            configFileProvider([configFile(fileId: 'google_app_cred', variable: 'GOOGLE_CRED')]) { 
                container('python') {
                    script {
                        def values = "${CLUSTER}".split('_')
                        println values[3]
                        sh """
                            echo '${values[3]}'
                            mkdir -p ~/.kube
                            cp ${GOOGLE_CRED} ${WORKSPACE}/google_application_cred
                            export GOOGLE_APPLICATION_CREDENTIALS='${WORKSPACE}/google_application_cred'
                            /usr/local/gcloud/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${WORKSPACE}/google_application_cred
                            /usr/local/gcloud/google-cloud-sdk/bin/gcloud config set project spacemesh-198810
                            /usr/local/gcloud/google-cloud-sdk/bin/gcloud container clusters get-credentials spacemesh-lab1 --zone us-east1-b --project spacemesh-198810
                        """
                        if ("${TESTS}" == 'All') {
                            sh """
                                echo "Run All tests"
                                export ES_PASSWD="${SECRET}"
                                export GOOGLE_APPLICATION_CREDENTIALS='${WORKSPACE}/google_application_cred'
                                pytest -s -v ./tests/p2p/test_p2p.py --tc-file=./tests/p2p/config.yaml --tc-format=yaml
                            """
                        }
                        else {
                            sh """
                                set +x
                                echo "Run test: ${TESTS}"
                                export ES_PASSWD="${ESPASS}"
                                export PYTHONUNBUFFERED=1
                                export GOOGLE_APPLICATION_CREDENTIALS='${WORKSPACE}/google_application_cred'
                                pytest -s -v ./tests/p2p/test_p2p.py::"${TESTS}" --tc-file=./tests/p2p/config.yaml --tc-format=yaml
                            """
                        }
                    }
                }
            }
        }
    }
  }
}
